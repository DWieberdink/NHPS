<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NHPS Schools Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CSS Librarie -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

  <!-- JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js" defer></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js" defer></script>
  <script src="https://d3js.org/d3.v7.min.js" defer></script>
  <script src="DecisionLogic.js" defer></script>
  <script src="FlowchartLogic.js" defer></script>
  <script src="script.js" defer></script>
  


  <style>
    /* General Layout */
   
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden; /* Prevent the whole page from scrolling */
    }

    #container {
  display: flex;
  height: 100vh;
  width: 100vw;
  position: relative; /* For positioning child elements like buttons */
}

    #sidebar { 
      width: 35%; 
      padding: 10px; 
      background: #f9f9f9; 
      border-right: 1px solid #ddd; 
      overflow-y: auto; 
      box-sizing: border-box; 
      display: flex;
      flex-direction: column;
    }
    
    #map-container {
  flex-grow: 1;
  height: 100vh;
  position: relative;
  transition: margin-right 0.3s ease;
}
    #map {
      width: 100%;
      height: 100%;
    }

    /* Sidebar Elements */
    #sidebar h3 { margin-top: 20px; font-size: 16px; font-weight: bold; color: #333; border-bottom: 1px solid #ccc; padding-bottom: 4px; }
    select, input[type="range"], input[type="number"] {
      width: 100%; padding: 8px; margin: 6px 0 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box;
    }
    button {
      padding: 6px 12px; margin-top: 4px; margin-right: 6px;
      font-size: 14px; border: none; border-radius: 4px; cursor: pointer;
      background-color: #007cbf; color: white;
    }
    button:hover { background-color: #005e93; }

    /* Map Legend */
    .legend {
  position: absolute;
  bottom: 60px;
  left: 20px;
  background: white;
  border-radius: 6px;
  padding: 10px;
  font-size: 13px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  
  display: flex;
  flex-wrap: wrap; /* allow wrapping if space is tight */
  gap: 12px;
  align-items: center;
}

.legend h4 {
  display: none; /* Hide the vertical header if desired */
}

.legend-row {
  display: flex;
  align-items: center;
  gap: 6px;
  margin: 0;
}

.legend-swatch {
  display: inline-block;
  width: 14px;
  height: 14px;
  border-radius: 2px;
  border: 1px solid #ccc;
}



    /* Map Sidebar */
    #map-sidebar {
  width: 400px;
  flex-shrink: 0;
  display: flex; /* Use flexbox to manage child elements */
  flex-direction: column; /* Stack children vertically */
  height: 100vh; /* Make sidebar full viewport height */
  box-sizing: border-box;
  overflow-y: auto; /* Allow sidebar to scroll if content is too tall */
} 

/* Ensure the container inside the sidebar allows the iframe to grow */
#map-sidebar > div {
  display: flex;
  flex-direction: column;
  flex-grow: 1;
  padding: 0; /* Remove padding to allow full width */
}

/*map resizing based on user*/
#map-sidebar.hidden {
  width: 0 !important;
  padding: 0;
  overflow: hidden;
}

#map-sidebar.wide {
  width: 800px !important;
}

#map-sidebar-toggle { 
  position: absolute; 
  top: 10px; 
  right: 10px; 
  z-index: 1001; 
  transition: right 0.3s ease; 
  min-width: 100px;
}
#map-sidebar-toggle.hidden { right: 10px; }
 
   #map-sidebar {
  width: 400px;
  flex-shrink: 0;
} 

    /* Table & Range Sliders */
    #enrollmentRange, #seatsRange { margin: 10px 0; }
    #isoTable { width: 100%; overflow-x: auto; display: block; }
    #isoTable th, #isoTable td { padding: 6px; border: 1px solid #ccc; text-align: center; }
    .percent-cell { display: flex; justify-content: center; align-items: center; gap: 4px; }
    .assign-percent {
      width: 50px;
      padding: 2px 4px;
      font-size: 14px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 3px;
      margin: 0;
    }

    /* ✅ Styling for details/summary to create hierarchy */
    details {
      margin-top: 1rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 0.5rem;
    }
    details summary {
      font-weight: bold;
      cursor: pointer;
      padding: 0.5rem;
      margin: -0.5rem; /* Counteract padding to fill area */
      background-color: #f7f7f7;
      border-radius: 4px;
    }
    details[open] > summary {
      border-bottom: 1px solid #ddd;
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }
    .nested-details {
      margin-left: 1rem;
      border: none;
      border-top: 1px solid #eee;
      border-radius: 0;
      padding-left: 0;
      padding-right: 0;
    }
    .nested-details summary {
      background-color: transparent;
      font-weight: normal;
    }

    /* ✅ Slider styling for consistency */
    .slider-container {
      margin-bottom: 0.5rem;
    }
    .slider-container label {
      display: block;
      font-weight: normal;
      margin-bottom: 0.1rem;
    }
    .slider-container span {
      float: right;
      font-weight: normal;
      background-color: #e9ecef;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.9em;
    }

    /* Loading Modal */
    #loadingModal {
      display: none; position: fixed; z-index: 2000; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      justify-content: center; align-items: center;
      font-size: 20px; font-weight: bold; color: #333;
    }

    /* Flowchart Styles */
    .ellipse-node {fill: #fbdbdb;stroke: #ccc; stroke-width: 1.5;}
    .node rect { fill: #fff; stroke: #999; stroke-width: 1.5px; }
    .node.highlight rect { fill: #ffeeba; stroke: #f0ad4e; }
    .node.special-highlight rect { fill: #dd00ff; stroke: #9900cc; }
    .node.special-highlight ellipse,
    .node.special-highlight rect {stroke: #000000; stroke-width: 3; fill: #eb77fd;}
    .link { stroke: #ccc; fill: none; stroke-width: 2px; }
    .link.active { stroke: #f0ad4e; stroke-width: 3px; marker-end: url(#arrow-active); }
    .link-label.active-label { fill: red; font-size: 14px; font-family: Franklin Gothic Book; font-weight: bold; pointer-events: none;}

    /* ✅ Styles for the main flowchart container to fit in the layout */
    #main-flowchart-container {
      flex-grow: 1;
      position: relative;
      background: #fdfdfd; /* A very light grey, almost white */
      display: none;
      flex-direction: column; /* Arrange header and SVG vertically */
      padding: 1rem; /* Give some spacing around the content */
      box-sizing: border-box;
    }

    .flowchart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-shrink: 0;
    }

    .flowchart-header h2 {
      margin: 0; 
      color: #333;
    }

    .school-select-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .school-select-container label {
      margin: 0; 
      font-weight: bold;
    }

    #mainFlowchartSchoolSelect {
      min-width: 250px;
    }

    .sidebar-toggle-btn {
      white-space: nowrap;
    }

    .flowchart-svg-container {
      flex-grow: 1; /* Take up remaining space */
      position: relative;
      overflow: hidden;
    }

    #main-flowchart-svg {
      width: 100%;
      height: 100%;
    }

    /* Sidebar Footer */
    .sidebar-footer {
      margin-top: auto;
      padding: 10px; /* Halved padding */
      text-align: center;
      border-top: 1px solid #ddd;
    }
    .footer-text {
      color: #666;
      font-size: 14px;
      margin-bottom: 12px;
    }
    .footer-logos {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 12px;
      min-height: 50px;
    }
    .nhps-logo {
      height: 45px;
      width: auto;
    }
    .pe-logo {
      width: 70%; /* Control by width instead of height */
      max-width: 200px; /* Set a max-width for very large screens */
      height: auto;
    }

    /* ✅ Styles for map-overlay filter panel */
    #filter-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: white;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }
    #filter-panel summary {
      padding: 10px 15px;
      background-color: #fff;
    }
    #filter-panel-content {
      padding: 0 15px 15px 15px;
      width: 250px;
    }
    #filter-panel-content h3 {
      font-size: 1em;
      margin-top: 15px;
      margin-bottom: 5px;
    }
    #filter-panel .nouislider-container {
      margin-top: 10px;
    }
    /* Make noUiSlider match the theme */
    #filter-panel .noUi-connect {
        background: #007cbf;
    }
    #filter-panel .noUi-handle {
        border-radius: 50%;
        border: 1px solid #ccc;
        box-shadow: none;
    }
    #filter-panel .noUi-handle:after, #filter-panel .noUi-handle:before {
        display: none;
    }
    #filter-panel .toggle-buttons {
      display: flex;
      gap: 0;
      border: 1px solid #007cbf;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }
    #filter-panel .toggle-buttons button {
      flex-grow: 1;
      margin: 0;
      border: none;
      background-color: #fff;
      color: #007cbf;
      border-radius: 0;
    }
    #filter-panel .toggle-buttons button.active {
      background-color: #007cbf;
      color: white;
    }
    
    /* ✅ General toggle buttons styling for sidebar and other areas */
    .toggle-buttons {
      display: flex;
      gap: 0;
      border: 1px solid #007cbf;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }
    .toggle-buttons button {
      flex-grow: 1;
      margin: 0;
      border: none;
      background-color: #fff;
      color: #007cbf;
      border-radius: 0;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
    }
    .toggle-buttons button:hover {
      background-color: #f0f8ff;
    }
    .toggle-buttons button.active {
      background-color: #007cbf;
      color: white;
    }

    /* Custom colors for Map/Flowchart toggle */
    .toggle-buttons.map-flowchart-toggle {
      border-color: #28a745;
    }
    .toggle-buttons.map-flowchart-toggle button {
      color: #28a745;
    }
    .toggle-buttons.map-flowchart-toggle button.active {
      background-color: #28a745;
      color: white;
    }
    .toggle-buttons.map-flowchart-toggle button:hover {
      background-color: #f0fff0;
    }

    /* Style for the "How to use" section */
    .how-to-use-summary {
      background-color: #004d40 !important; /* Dark Green */
      color: white !important;
    }
    .how-to-use-summary:hover {
      background-color: #0e6e34 !important;
    }

    /* Welcome Popup Styles */
    .welcome-popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .welcome-popup {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .welcome-popup h2 {
      color: #0033A0;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .welcome-popup p {
      color: #333;
      line-height: 1.6;
      margin-bottom: 25px;
      font-size: 16px;
    }

    .password-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      margin-bottom: 15px;
      text-align: center;
    }

    .password-input:focus {
      outline: none;
      border-color: #0033A0;
    }

    .enter-btn {
      background-color: #0033A0;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .enter-btn:hover {
      background-color: #002266;
    }

    .enter-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .error-message {
      color: #e74c3c;
      font-size: 14px;
      margin-top: 10px;
      display: none;
    }

    /* Sidebar Toggle Button Group */
    .sidebar-toggle-group {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1001;
      display: flex;
      gap: 2px;
      background: white;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      padding: 2px;
    }

    .sidebar-toggle-btn {
      padding: 6px 12px;
      font-size: 12px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      background-color: #f8f9fa;
      color: #495057;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .sidebar-toggle-btn:hover {
      background-color: #e9ecef;
    }

    .sidebar-toggle-btn.active {
      background-color: #007cbf;
      color: white;
    }

    /* Positioning for the map view toggle group */
    #map-toggle-group {
      position: fixed;
      top: 10px;
      right: 410px; /* Default for normal sidebar */
      transition: right 0.3s ease-in-out;
    }

    #map-toggle-group.state-wide {
      right: 810px;
    }

    #map-toggle-group.state-hidden {
      right: 10px;
    }

    /* Styles from DecisionPanel.html */
    .decision-panel-body { font-family: 'Segoe UI', sans-serif; padding: 0; margin: 0; }
    .decision-panel-body label { display: block; margin-top: 1rem; }
    .decision-panel-body table { border-collapse: collapse; width: 100%; }
    .decision-panel-body th, .decision-panel-body td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    .decision-panel-body th { background-color: #f2f2f2; }
    .decision-panel-body tr.ProgramInvestment { background-color: #d1f7e1; }
    .decision-panel-body tr.BuildingInvestment { background-color: #d1e7f7; }
    .decision-panel-body tr.BuildingProgramInvestment { background-color: #f7d1f1; }
    .decision-panel-body tr.BuildingAddition { background-color: #f9f9d1; }
    .decision-panel-body tr.Evaluation { background-color: #e6d1f7; }
    .decision-panel-body tr.Unknown { background-color: #fdd; }
    .decision-panel-body input[type=range] { width: 100%; }
    .decision-panel-body #main { max-width: 1200px; margin: 0 auto; padding: 0; }
    .decision-panel-body #container { display: flex; gap: 2rem; flex-wrap: wrap; }
    .decision-panel-body #sliders { flex: 1; min-width: 300px; }
    .decision-panel-body #summary { flex: 1; }
    .decision-panel-body #results { margin-top: 1rem; }
    .decision-panel-body tfoot tr th { font-weight: bold; background-color: #e8e8e8; }
    .decision-panel-body details { margin-top: 1rem; border: 1px solid #ddd; border-radius: 4px; padding: 0; }
    .decision-panel-body details summary { font-weight: bold; cursor: pointer; padding: 0.5rem; margin: 0; background-color: #f7f7f7; border-radius: 4px; }
    .decision-panel-body details[open] > summary { border-bottom: 1px solid #ddd; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
    .decision-panel-body #summary table { margin-top: 0; border: none; }
    .decision-panel-body #summary th { background-color: #f7f7f7; }
    .decision-panel-body .summary-table-container { padding-left: 0 !important; padding-right: 0 !important; }
    .truncate-cell { max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; position: relative; }
    .truncate-cell:hover { overflow: visible; white-space: normal; height: auto; }
    .truncate-cell:hover::after { content: attr(data-tooltip); position: absolute; left: 0; top: 100%; background-color: #333; color: white; padding: 5px; border-radius: 4px; z-index: 100; white-space: normal; width: max-content; max-width: 300px; }
    .decision-panel-body th.sortable-header { cursor: pointer; position: relative; }
    .decision-panel-body th.sortable-header:hover { background-color: #e2e2e2; }
    .decision-panel-body th.sortable-header::after { content: ''; position: absolute; right: 8px; top: 50%; margin-top: -8px; border-left: 5px solid transparent; border-right: 5px solid transparent; }
    .decision-panel-body th.sort-asc::after { border-bottom: 5px solid #666; }
    .decision-panel-body th.sort-desc::after { border-top: 5px solid #666; }

    /* Color-coding for related panels */
    #decision-input-panel, #decision-output-panel {
      border-left: 3px solid #b3c7ff; /* Lighter NHPS Blue */
    }
    #decision-input-panel > summary, #decision-output-panel > summary {
      background-color: #f0f4ff; /* Very Subtle NHPS Blue */
    }

    #scenario-input-panel, #scenario-output-panel {
      border-left: 3px solid #ffb3b3; /* Lighter NHPS Red */
    }
    #scenario-input-panel > summary, #scenario-output-panel > summary {
      background-color: #fff5f5; /* Very Subtle NHPS Red */
    }

    /* Generic styles for all data tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .data-table th, .data-table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      vertical-align: middle;
    }
    .data-table th {
      background-color: #f2f2f2;
    }
    .data-table .text-center {
      text-align: center;
    }

    /* Specific padding for the isochrone table to keep row height normal */
    #isoTable td {
      padding-top: 2px;
      padding-bottom: 2px;
    }

    #summary table {
      margin-top: 0;
    }
  </style>
</head>

<body>
  <!-- Welcome Popup -->
  <div id="welcomePopup" class="welcome-popup-overlay">
    <div class="welcome-popup">
      <h2>NHPS Facility Planning Tool</h2>
      <p>This tool is intended to support NHPS facility planning initiatives. Users can explore conditions data and model school choice scenarios to better understand the potential impact of facility decisions.</p>
      <input type="password" id="passwordInput" class="password-input" placeholder="Enter password" />
      <button id="enterBtn" class="enter-btn">Enter</button>
      <div id="errorMessage" class="error-message">Incorrect password. Please try again.</div>
    </div>
  </div>

<div id="sidebar">
  <details>
    <summary class="how-to-use-summary"><strong>How to use the NHPS Planning Tool</strong></summary>
    <h3>NHPS Facility Planning Dashboard</h3>
    <p>This tool is intended to support NHPS facility planning initiatives. Users can explore conditions data and model school choice scenarios to better understand the potential impact of facility decisions.</p>
  </details>

  
  <script>
  function switchControlIframe(url) {
    document.getElementById('controlIframe').src = url;
  }
  </script>
  

  <details id="decision-input-panel">
    <summary><strong>School Decision Evaluation</strong></summary>
    <div id="decision-sliders" style="padding-top: 1rem;">
      <label>Utilization Threshold: <span id="utilOut">0.65</span>
        <input type="range" id="utilSlider" min="0" max="1" step="0.01" value="0.65">
      </label>
      <label>High Utilization Threshold: <span id="utilHighOut">0.95</span>
        <input type="range" id="utilHighSlider" min="0" max="1.2" step="0.01" value="0.95">
      </label>
      <label>Enrollment Growth Threshold: <span id="growthOut">0</span>
        <input type="range" id="growthSlider" min="-3" max="3" step="0.01" value="0">
      </label>
      <label>Projected Utilization Threshold: <span id="projUtilOut">0.95</span>
        <input type="range" id="projUtilSlider" min="0" max="1.5" step="0.01" value="0.95">
      </label>
      <label>Distance to Underutilized Schools: <span id="distOut">1.0</span>
        <input type="range" id="distSlider" min="0" max="5" step="0.1" value="1.0">
      </label>
      <label>Building Threshold: <span id="buildOut">1.5</span>
        <input type="range" id="buildSlider" min="0" max="3" step="0.1" value="1.5">
      </label>
      <label>Adequate Program Offer Minimum: <span id="progOut">2</span>
        <input type="range" id="progSlider" min="0" max="10" step="1" value="2">
      </label>
    </div>
  </details>

  <details id="scenario-input-panel">
    <summary><strong>Scenario Modeling</strong></summary>
    <div style="padding: 10px 0;">
      <h4>Use this section to test and evaluate the impact of portfolio decisions. Users can manually assign student changes or run a simulation model.</h4>

      <h3>Filter by Decision Type</h3>
      <select id="decisionFilter">
        <option value="">-- All Decisions --</option>
      </select>

      <h3>Select a School for Evaluation</h3>
      <select id="schoolSelect">
        <option value="">-- Select --</option>
      </select>
    </div>

    <details open class="nested-details">
      <summary><strong>Assignment Mode</strong></summary>

      <div id="modeToggle" style="padding-top: 10px;">
        <div class="toggle-buttons">
          <button id="manualBtn" class="active">Manual Entry</button>
          <button id="modelBtn">Model Simulation</button>
        </div>
      </div>

      <!-- Manual Entry View -->
      <div id="manualView">
        <h3>Select Distance Threshold for Analysis</h3>
        <select id="isoDistance">
          <option value="2413">1.5 miles</option>
          <option value="1609">1 mile</option>
          <option value="804">0.5 mile</option>
        </select>

        <h3>Schools within Distance Threshold</h3>
        <table id="isoTable" class="data-table">
          <thead>
            <tr>
              <th>School Name</th>
              <th class="text-center">% Assigned</th>
              <th class="text-center"># Assigned</th>
              <th class="text-center">Available Seats</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Model Simulation View -->
      <div id="modelView" style="display: none;">
        <h4>Rate the importance of each factor (1 = not important, 10 = very important)</h4>
        
        <div class="slider-container">
          <label for="distanceWeightSlider">Distance Weighting <span id="distanceWeightLabel">5</span></label>
          <input type="range" id="distanceWeightSlider" min="1" max="10" value="5" />
        </div>

        <div class="slider-container">
          <label for="enrollmentWeightSlider">Enrollment Demand <span id="enrollmentWeightLabel">5</span></label>
          <input type="range" id="enrollmentWeightSlider" min="1" max="10" value="5" />
        </div>

        <div class="slider-container">
          <label for="buildingWeightSlider">Building Quality <span id="buildingWeightLabel">5</span></label>
          <input type="range" id="buildingWeightSlider" min="1" max="10" value="5" />
        </div>
        
        <div class="slider-container">
          <label for="scorecardWeightSlider">Scorecard Weighting <span id="scorecardWeightLabel">5</span></label>
          <input type="range" id="scorecardWeightSlider" min="1" max="10" value="5" />
        </div>

          <h3>Exclude Schools from Assignment</h3>
          <select id="excludedSchools" multiple style="height: 100px;">
            <!-- Options will be dynamically added -->
          </select>

        <br /><br />
        <button id="assignButton" onclick="console.log('🔘 Assign button clicked via inline handler!')">Assign Students</button>
      </div>
    </details>
  </details>

  <div class="sidebar-footer">
    <p class="footer-text">Developed by</p>
    <div class="footer-logos">
      <img src="nhps-logo.png" alt="New Haven Public Schools Logo" class="nhps-logo">
      <img src="PerkinsEastmanLogo.svg" alt="Perkins Eastman Logo" class="pe-logo">
    </div>
    <p class="footer-text">School Facility Planning Webtool</p>
  </div>
</div>

<div id="container">
  
  <div id="map-container">
    <div id="map"></div>

     <div id="map-legend" class="legend">
      <h4>Legend</h4>
      <div id="legend-content"></div>
    </div>
    
    <!-- Decisions/Assignments Toggle positioned below legend -->
    <div class="toggle-buttons" style="position: absolute; bottom: 20px; left: 20px; z-index: 999;">
      <button id="toggleViewDecisions" class="active">Show Decisions</button>
      <button id="toggleViewAssignments">Show Assignments</button>
    </div>
   
    <details id="filter-panel">
        <summary><strong>Map Filters</strong></summary>
        <div id="filter-panel-content">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3>School Type</h3>
              <button id="unselectAllSchoolsBtn" style="font-size: 11px; padding: 2px 5px; margin: 0; border-radius: 3px; cursor: pointer;">Unselect All</button>
            </div>
            <select id="schoolTypeFilter" multiple size="4">
                <option value="Elementary and K-8 Schools">ES & K8</option>
                <option value="Middle School">MS</option>
                <option value="High School">HS</option>
                <option value="Early Childhood Program">ECP</option>
            </select>

            <h3>Enrollment Range</h3>
            <div id="enrollmentRangeSlider"></div>
            <div>Min: <span id="minEnrollDisplay">0</span> – Max: <span id="maxEnrollDisplay">2000</span></div>

            <h3>Available Seats</h3>
            <div id="seatsRangeSlider"></div>
            <div>Min: <span id="minSeatsDisplay">0</span> – Max: <span id="maxSeatsDisplay">500</span></div>

            <h3>Show Size by Seats</h3>
            <div class="toggle-buttons">
                <button id="toggleYes">Yes</button>
                <button id="toggleNo" class="active">No</button>
            </div>
        </div>
    </details>

    <!-- Right Sidebar -->
    <div class="sidebar-toggle-group" id="map-toggle-group">
      <button id="sidebar-wide-btn" class="sidebar-toggle-btn">Wide</button>
      <button id="sidebar-normal-btn" class="sidebar-toggle-btn active">Normal</button>
      <button id="sidebar-hidden-btn" class="sidebar-toggle-btn">Hidden</button>
    </div>
    
    <!-- Map/Flowchart Toggle for Map View -->
    <div class="toggle-buttons map-flowchart-toggle" style="position: absolute; bottom: 20px; right: 20px; z-index: 999;">
      <button id="toggleMapFlowchartMap" class="active">Show Map</button>
      <button id="toggleMapFlowchartFlowchart">Show Flowchart</button>
    </div>
  </div>

  <!-- 👇 Flowchart Container - Centered with Flexbox -->
  <div id="main-flowchart-container">
      <div class="flowchart-header">
        <div class="school-select-container">
          <label for="mainFlowchartSchoolSelect">Select School:</label>
          <select id="mainFlowchartSchoolSelect">
            <option value="">-- Select School --</option>
          </select>
        </div>
        <button id="flowchart-sidebar-toggle" class="sidebar-toggle-btn">Toggle Panel</button>
      </div>
      
      <div class="flowchart-svg-container">
        <svg id="main-flowchart-svg"></svg>
      </div>
      
      <!-- Map/Flowchart Toggle for Flowchart View -->
      <div class="toggle-buttons map-flowchart-toggle" style="position: absolute; bottom: 20px; right: 20px; z-index: 999;">
        <button id="toggleMapFlowchartMap2">Show Map</button>
        <button id="toggleMapFlowchartFlowchart2" class="active">Show Flowchart</button>
      </div>
  </div>

  <div id="map-sidebar">
    <div style="padding: 0.5rem; display: flex; flex-direction: column; flex-grow: 1;">
      <details>
        <summary class="how-to-use-summary"><strong>How to interpret the outcomes</strong></summary>
        <div style="padding: 0.5rem;">
          <h3>School & Student Decisions</h3>
          <p>In this section you see the results of your choices. It has two key functions:

            Evaluation Results: When you adjust the evaluation sliders on the left (like utilization or building condition), this section instantly updates to show recommended actions for each school—both in summary and detailed views.
            
            Scenario Impact Analysis: After running a simulation (like closing a school), this section displays the effects—such as where students will go, how enrollment shifts, and how travel distances change.</p>
        </div>
      </details>

      <!-- Content from DecisionPanel.html -->
      <div id="decision-panel-content" class="decision-panel-body">
        <div id="main">
          <details id="decision-output-panel" open>
            <summary><strong>School Decision Evaluation: Results</strong></summary>
            <div class="details-content-wrapper" style="padding: 0.5rem;">
              <details open>
                <summary><strong>Summary Table</strong></summary>
                <div class="details-content-wrapper" style="padding: 0.5rem;">
                  <div id="summary" style="padding: 0;"></div>
                </div>
              </details>
              <details>
                <summary><strong>Decision by School</strong></summary>
                <div class="details-content-wrapper" style="padding: 0.5rem;">
                  <div id="results" style="padding: 0;"></div>
                </div>
              </details>
            </div>
          </details>
          <details id="scenario-output-panel" open>
            <summary><strong>Model Output: Impact Analysis</strong></summary>
            <div class="details-content-wrapper" style="padding: 1rem;">
                <h3>Enrollment and Utilization Impact</h3>
                <canvas id="assignmentChart" width="100%" height="180"></canvas>
                <h3>Travel Distance Impact</h3>
                <canvas id="distanceCompareChart" width="100%" height="50"></canvas>
                <div id="assignmentSummary" style="margin-top: 10px;"></div>
            </div>
          </details>
        </div>
      </div>
    </div> <!-- end of style="padding:10px;" -->
  </div> <!-- end of #map-sidebar -->

</div> <!-- end of #container -->

<!-- Student Assignment Count Popup (overlay) -->
<div id="assignmentProgress" style="
  display: none;
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.85);
  color: white;
  padding: 40px 60px;
  border-radius: 12px;
  font-size: 32px;
  font-weight: bold;
  z-index: 2001;
  text-align: center;
  box-shadow: 0 0 20px rgba(0,0,0,0.6);
">
  Running Student Assignment Scenarios<br/>
  <span id="assignedCount" style="font-size: 48px; display: block; margin-top: 12px;">0</span>
  <button id="cancelAssignment" style="
    margin-top: 20px;
    padding: 10px 20px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
  ">Cancel Assignment</button>
</div>

<!-- Outside: Loading Modal -->
<div id="loadingModal">Please wait, assignment algorithm is running...</div>

<!-- Scripts -->
<!-- The script tags have been moved to the <head> for better dependency management -->

<!-- Assignment Results Modal -->
<div id="assignmentResultsModal" style="display:none; position:fixed; top:20%; left:50%; transform:translate(-50%,0); background:white; border:2px solid #333; padding:30px; z-index:2000; min-width:350px; box-shadow:0 4px 24px rgba(0,0,0,0.2);">
  <div id="assignmentResultsContent"></div>
  <button onclick="document.getElementById('assignmentResultsModal').style.display='none'" style="margin-top:20px; padding:8px 18px; background:#007cbf; color:white; border:none; border-radius:4px;">Close</button>
</div>
<!-- End Assignment Results Modal -->

</body>
</html>
