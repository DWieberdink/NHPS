<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NHPS Dynamic Workflow Viewer</title>
</head>
<body>

    <h2>NHPS Dynamic Workflow Viewer</h2>

    <!-- Dropdown to select school -->
    <label for="schoolSelector">Choose a school:</label>
    <select id="schoolSelector" onchange="updateWorkflow()">
        <option value="" disabled selected>Loading schools...</option>
    </select>

    <!-- Slider to change utilization -->
    <label for="utilizationSlider">Utilization: <span id="utilizationValue">50</span>%</label>
    <input type="range" id="utilizationSlider" min="30" max="100" step="5" value="50" oninput="updateWorkflow()">

    <!-- Display the Draw.io workflow -->
    <iframe id="flowchart" width="100%" height="600px"></iframe>

    <script>
        let schoolData = {}; // Store school data from JSON

        async function loadData() {
            try {
                console.log("Fetching data.json...");
                let response = await fetch("data.json");

                if (!response.ok) {
                    throw new Error(`Failed to load data.json: ${response.status} ${response.statusText}`);
                }

                let data = await response.json();
                schoolData = data.schools;

                console.log("‚úÖ Loaded school data:", schoolData);

                let schoolSelector = document.getElementById("schoolSelector");
                schoolSelector.innerHTML = ""; // Clear previous options

                if (!schoolData || Object.keys(schoolData).length === 0) {
                    console.error("‚ùå No schools found in data.json!");
                    return;
                }

                // Populate dropdown with schools
                for (let school in schoolData) {
                    let option = document.createElement("option");
                    option.value = school;
                    option.textContent = schoolData[school].name;
                    schoolSelector.appendChild(option);
                }

                console.log("‚úÖ Schools added to dropdown!");
                schoolSelector.selectedIndex = 0; // Set default selection
                updateWorkflow(); // Load initial workflow

            } catch (error) {
                console.error("‚ùå Error loading school data:", error);
            }
        }

        function updateWorkflow() {
            let selectedSchool = document.getElementById("schoolSelector").value;
            let utilization = parseInt(document.getElementById("utilizationSlider").value);
            document.getElementById("utilizationValue").textContent = utilization;

            if (!selectedSchool || !schoolData[selectedSchool]) {
                console.error("‚ùå Invalid school selection:", selectedSchool);
                return;
            }

            let school = schoolData[selectedSchool];

            // Determine workflow based on utilization
            let workflowType = school.defaultWorkflow;
            if (utilization <= 50) {
                workflowType = school.workflows.low;
            } else if (utilization > 50 && utilization <= 70) {
                workflowType = school.workflows.medium;
            } else {
                workflowType = school.workflows.high;
            }

            console.log(`üéØ Selected School: ${school.name}, Utilization: ${utilization}, Workflow: ${workflowType}`);

            fetch("data.json")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("flowchart").src = data.workflows[workflowType].url;
                })
                .catch(error => console.error("‚ùå Error fetching workflow data:", error));
        }

        // ‚úÖ Load the data when the page starts
        loadData();
    </script>

</body>
</html>
