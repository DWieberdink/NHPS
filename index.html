<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic NHPS Workflows</title>
</head>
<body>

    <h2>NHPS Dynamic Workflow Viewer</h2>

    <!-- Dropdown to select school -->
    <label for="schoolSelector">Choose a school:</label>
    <select id="schoolSelector" onchange="updateWorkflow()">
        <option value="" disabled selected>Loading schools...</option>
    </select>

    <!-- Slider to change utilization -->
    <label for="utilizationSlider">Utilization: <span id="utilizationValue">50</span>%</label>
    <input type="range" id="utilizationSlider" min="30" max="100" step="5" value="50" oninput="updateWorkflow()">

    <!-- Button to toggle Q1 shape -->
    <button onclick="toggleShapeVisibility()">Toggle Q1</button>

    <!-- Display selected workflow -->
    <iframe id="flowchart" width="100%" height="600px"></iframe>

    <script>
        let schoolData = {}; // Store school data from JSON

        async function loadData() {
            try {
                console.log("Fetching data.json...");
                let response = await fetch("data.json");
                
                // Check if response is ok
                if (!response.ok) {
                    throw new Error("Failed to load data.json");
                }
                
                let data = await response.json();
                schoolData = data.schools;

                console.log("Loaded schools:", schoolData);

                let schoolSelector = document.getElementById("schoolSelector");
                schoolSelector.innerHTML = ""; // Clear existing options

                // Populate dropdown with schools
                for (let school in schoolData) {
                    let option = document.createElement("option");
                    option.value = school;
                    option.textContent = schoolData[school].name;
                    schoolSelector.appendChild(option);
                }

                // Set default selection to the first school
                schoolSelector.selectedIndex = 0;

                updateWorkflow(); // Load workflow based on default selection

            } catch (error) {
                console.error("Error loading data.json:", error);
            }
        }

        function updateWorkflow() {
            let schoolSelector = document.getElementById("schoolSelector");
            let selectedSchool = schoolSelector.value;
            let utilization = parseInt(document.getElementById("utilizationSlider").value);
            document.getElementById("utilizationValue").textContent = utilization; // Update displayed value

            if (!selectedSchool || !schoolData[selectedSchool]) {
                console.error("Invalid school selection:", selectedSchool);
                return;
            }

            let school = schoolData[selectedSchool];

            // Determine workflow based on utilization
            let workflowType = school.defaultWorkflow; // Default
            if (utilization <= 50) {
                workflowType = school.workflows.low;
            } else if (utilization > 50 && utilization <= 70) {
                workflowType = school.workflows.medium;
            } else {
                workflowType = school.workflows.high;
            }

            console.log(`Selected School: ${school.name}, Utilization: ${utilization}, Workflow: ${workflowType}`);

            // Get the workflow URL
            fetch("data.json")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("flowchart").src = data.workflows[workflowType].url;
                })
                .catch(error => console.error("Error fetching workflow data:", error));
        }

        function toggleShapeVisibility() {
            const frame = document.getElementById("flowchart").contentWindow;

            // Request diagram data
            frame.postMessage(JSON.stringify({ action: "get" }), "*");

            window.addEventListener("message", function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data.action === "load") {
                        const cells = data.diagram.cells;

                        // Find the shape with Unique ID "Q1"
                        const shape = cells.find(cell => cell.id === "Q1");

                        if (shape) {
                            // Check if shape is already hidden (opacity=0)
                            const isHidden = shape.style && shape.style.includes("opacity=0");
                            const newStyle = isHidden ? shape.style.replace("opacity=0", "") : shape.style + ";opacity=0";

                            // Send command to modify the shape style
                            frame.postMessage(JSON.stringify({
                                action: "execute",
                                value: {
                                    action: "style",
                                    cells: [shape.id],
                                    value: newStyle
                                }
                            }), "*");
                        } else {
                            console.warn("Shape with ID 'Q1' not found.");
                        }
                    }
                } catch (error) {
                    console.error("Error processing message:", error);
                }
            }, { once: true });
        }

        // Load data when the page loads
        loadData();
    </script>

</body>
</html>
